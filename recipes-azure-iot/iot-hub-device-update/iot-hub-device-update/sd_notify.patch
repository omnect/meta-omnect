From 36d8feec267c76df3749ed2023f1d2456f19c3e2 Mon Sep 17 00:00:00 2001
From: JoergZeidler <62105035+JoergZeidler@users.noreply.github.com>
Date: Thu, 19 Jan 2023 16:38:09 +0100
Subject: [PATCH] sd notify (#16)

---
 src/agent/CMakeLists.txt |  3 ++-
 src/agent/src/main.c     | 10 ++++++++++
 2 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/src/agent/CMakeLists.txt b/src/agent/CMakeLists.txt
index de23518a..74f3c628 100644
--- a/src/agent/CMakeLists.txt
+++ b/src/agent/CMakeLists.txt
@@ -96,7 +96,8 @@ target_link_libraries (
             aduc::pnp_helper
             aduc::system_utils
             diagnostics_component::diagnostics_interface
-            diagnostics_component::diagnostics_devicename)
+            diagnostics_component::diagnostics_devicename
+            systemd)
 
 if (ADUC_IOT_HUB_PROTOCOL STREQUAL "MQTT")
     target_compile_definitions (${target_name} PRIVATE ADUC_ALLOW_MQTT=1)
diff --git a/src/agent/src/main.c b/src/agent/src/main.c
index bd35a67f..b6c39ff9 100644
--- a/src/agent/src/main.c
+++ b/src/agent/src/main.c
@@ -59,6 +59,8 @@
 
 #include "eis_utils.h"
 
+#include <systemd/sd-daemon.h>
+
 /**
  * @brief Make getopt* stop parsing as soon as non-option argument is encountered.
  * @remark See GETOPT.3 man page for more details.
@@ -1229,6 +1231,7 @@ int main(int argc, char** argv)
     int dir_result = ADUC_SystemUtils_MkDirRecursiveDefault(ADUC_DATA_FOLDER);
     if (dir_result != 0)
     {
+        ret=dir_result;
         Log_Error("Cannot create data folder.");
         goto done;
     }
@@ -1246,6 +1249,13 @@ int main(int argc, char** argv)
 
     if (!StartupAgent(&launchArgs))
     {
+        ret=1;
+        goto done;
+    }
+    else if ( 0 >= sd_notify(0, "READY=1") )
+    {
+        Log_Error("sd_notify failed");
+        ret = 255;
         goto done;
     }
 
-- 
2.34.1

