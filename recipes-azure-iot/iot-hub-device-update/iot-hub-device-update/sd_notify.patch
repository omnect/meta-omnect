From 0fdd671ac15c3a51e0d9aa32b8288e35b2b9bc6c Mon Sep 17 00:00:00 2001
From: Joerg Zeidler <joerg.zeidler@conplement.de>
Date: Fri, 11 Nov 2022 11:28:00 +0100
Subject: [PATCH] add sd notify

---
 src/agent/CMakeLists.txt |  3 ++-
 src/agent/src/main.c     | 10 ++++++++++
 2 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/src/agent/CMakeLists.txt b/src/agent/CMakeLists.txt
index ff66816c..41396d87 100644
--- a/src/agent/CMakeLists.txt
+++ b/src/agent/CMakeLists.txt
@@ -95,7 +95,8 @@ target_link_libraries (
             aduc::pnp_helper
             aduc::system_utils
             diagnostics_component::diagnostics_interface
-            diagnostics_component::diagnostics_devicename)
+            diagnostics_component::diagnostics_devicename
+            systemd)
 
 if (ADUC_IOT_HUB_PROTOCOL STREQUAL "MQTT")
     target_compile_definitions (${target_name} PRIVATE ADUC_ALLOW_MQTT=1)
diff --git a/src/agent/src/main.c b/src/agent/src/main.c
index 9d434c3d..53d32ad8 100644
--- a/src/agent/src/main.c
+++ b/src/agent/src/main.c
@@ -58,6 +58,8 @@
 
 #include "eis_utils.h"
 
+#include <systemd/sd-daemon.h>
+
 /**
  * @brief The timeout for the Edge Identity Service HTTP requests
  */
@@ -1504,6 +1506,7 @@ int main(int argc, char** argv)
     int dir_result = ADUC_SystemUtils_MkDirRecursiveDefault(ADUC_DATA_FOLDER);
     if (dir_result != 0)
     {
+        ret=dir_result;
         Log_Error("Cannot create data folder.");
         goto done;
     }
@@ -1521,6 +1524,13 @@ int main(int argc, char** argv)
 
     if (!StartupAgent(&launchArgs))
     {
+        ret=1;
+        goto done;
+    }
+    else if ( 0 >= sd_notify(0, "READY=1") )
+    {
+        Log_Error("sd_notify failed");
+        ret = 255;
         goto done;
     }
 
-- 
2.34.1

