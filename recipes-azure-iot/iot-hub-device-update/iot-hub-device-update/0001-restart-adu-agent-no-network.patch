From afff296a5f494895cac63d4b219704441352e6d2 Mon Sep 17 00:00:00 2001
From: JoergZeidler <joerg.zeidler@conplement.de>
Date: Mon, 6 Mar 2023 14:16:27 +0100
Subject: [PATCH] added restart handling in case adu-agent get "No Network"
 conn state (#18)

fixed typo (#19)
---
 .../iothub_communication_manager/CMakeLists.txt       |  3 ++-
 .../src/iothub_communication_manager.c                | 11 +++++++++--
 2 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/src/communication_managers/iothub_communication_manager/CMakeLists.txt b/src/communication_managers/iothub_communication_manager/CMakeLists.txt
index aff2425..a7c8a86 100644
--- a/src/communication_managers/iothub_communication_manager/CMakeLists.txt
+++ b/src/communication_managers/iothub_communication_manager/CMakeLists.txt
@@ -19,7 +19,8 @@ find_package (umqtt REQUIRED)
 target_link_libraries (
     ${PROJECT_NAME}
     PUBLIC aduc::adu_types
-    PRIVATE aduc::communication_abstraction
+    PRIVATE aduc::adu_core_export_helpers
+            aduc::communication_abstraction
             aduc::config_utils
             aduc::c_utils
             aduc::eis_utils
diff --git a/src/communication_managers/iothub_communication_manager/src/iothub_communication_manager.c b/src/communication_managers/iothub_communication_manager/src/iothub_communication_manager.c
index b6611f6..1cff8e9 100644
--- a/src/communication_managers/iothub_communication_manager/src/iothub_communication_manager.c
+++ b/src/communication_managers/iothub_communication_manager/src/iothub_communication_manager.c
@@ -5,6 +5,7 @@
  * @copyright Copyright (c) Microsoft Corporation.
  * Licensed under the MIT License.
  */
+#include "aduc/adu_core_export_helpers.h" // ADUC_MethodCall_RestartAgent
 #include "aduc/adu_types.h"
 #include "aduc/client_handle_helper.h"
 #include "aduc/config_utils.h"
@@ -725,9 +726,15 @@ static void Connection_Maintenance()
             additionalDelayInSeconds = TIME_SPAN_FIVE_MINUTES_IN_SECONDS;
             break;
         case IOTHUB_CLIENT_CONNECTION_NO_NETWORK:
-            // Could be transient error, wait for at least 5 minutes to retry.
+            // Workaround for empty reported properties in module twin 
+            // 1) try to restart agent
+            // 2) if restart agent could not be performed, wait for at least 5 minutes to retry.
             Log_Error("No network.");
-            additionalDelayInSeconds = TIME_SPAN_FIVE_MINUTES_IN_SECONDS;
+            if (ADUC_MethodCall_RestartAgent() != 0)
+            {
+                additionalDelayInSeconds = TIME_SPAN_FIVE_MINUTES_IN_SECONDS;
+                Log_Error("Agent restart attempt failed.");
+            }
             break;
 
         case IOTHUB_CLIENT_CONNECTION_COMMUNICATION_ERROR:
-- 
2.34.1

